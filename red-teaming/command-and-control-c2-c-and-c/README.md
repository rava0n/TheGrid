# Command & Control (C2 / C\&C)

**Command and Control (C2 or C\&C)** refers to the communication structure used by attackers to **remotely control** and **coordinate activities** across compromised systems.\
It encompasses the methods, protocols, and infrastructure that enable attackers to **send commands**, **receive data**, and **manage** their operations in a coordinated manner.

C2 typically **consists** of a **central C2 server** and **client software (agents)** installed on compromised endpoints.

<figure><img src="../../.gitbook/assets/image (107).png" alt="" width="375"><figcaption><p>Typically C2 Infrastructure</p></figcaption></figure>

**C2 Server**: A **central point** where attackers issue commands and process data sent by the compromised systems. It can be hosted on various platforms, like on-premises, cloud services, or hidden services.

**C2 Agent**: **Software running on the compromised systems** that connects to the C2 server. It facilitates remote control and data transmission

**Communication Channel**: The **protocol and method** through which the C2 server **communicates** with agents. This can include HTTP(S), DNS, WebSockets, custom encrypted protocols, etc. The last method is used to avoid detection.

## C2 Frameworks

A **Command & Control Framework** is a **software platform** designed for managing, controlling, and orchestrating the activities of remote systems or devices in an offensive security context. \
In ehical scenarios like pentest and red teaming, these framworks enable security professionals to **simulate advanced attack scenarios** to assess an organization's security posture.

### C2 Framwork Functionality

* **Establish Communication Channels**: These channels can use variuos protocol to avoid detection.
* **Remote Control and Command Execution**: It allows to **execute commands** on remote endpoints, **access files**, **run scripts** and permorm other actions (like mimicking).
* **Persistence Mechanism**: This includes methods for ensuring that **C2 agents persist** through system reboots or other disruptions. Common persistence technique involve **modifying startup settings**, creating **scheduled tasks**, or installing **backdoors**.
* **Lateral Movement**:  They provide tools for **compromising additional systems**, **exploiting** network vulnerabilities, and **navigating** through different network segments.
* **Privilege Escalation**: C2 Framworks often **include modules** or **techniques** for escalating privileges on compromised systems.
* **Data Exfiltration**: C2 Framworks can be used to **collect** and **exfiltrate** data from compromised systems.
* **Automation & Scripting**: Use to **automation** and **scripting**, allowing operators to create **custom scripts** and automate repetitive tasks.
* **Evasion techniques**: C2F offer **evasion techniques** to help operators **avoid detection** by security tools like FW, IDS and endpoint security solutions.
* **Payload Development**: C2F allow fot **custom payload** development to **create unique payloads** or modify existing ones.
* Loggin & Reporting: C2F provide logging and reporting capabilities, allowing operators to track commands, collect data on operations, and generate reports for analysis.

### C2 Framework Terminology

<table data-full-width="true"><thead><tr><th width="202">Term</th><th>Definition</th></tr></thead><tbody><tr><td>C2 Server</td><td>This is the hub/server that agents call back to.</td></tr><tr><td>Listener</td><td>Listener process that runs on the C2 server or redirector. Listens for call backs from compromised hosts over a specific port or protocol and maintains communication between the two.</td></tr><tr><td>Agent</td><td>An agent is a piece of code or the mechanism that is generated by a C2 framework and calls back to a listener on a C2 server.</td></tr><tr><td>Implant</td><td>Mechanism that provides interactive remote access to a target system.</td></tr><tr><td>Beacon/Beaconing</td><td>This refers to when a compromised host with an active implant/agent calls-back to the C2 server for instructions.</td></tr><tr><td>Interface</td><td>Control mechanism providing operators with interactive access to the C2 server. (Empire Client)</td></tr><tr><td>Payload</td><td>Piece of code executed on target system in order to achieve a specific goal like establishing a reverse shell.</td></tr><tr><td>Stager</td><td>A stager is a small executable that is an initial payload. It is a relatively small piece of code that is executed to prepare for a much larger and more capable payload known as the stage payload.</td></tr><tr><td>Sleep Timer</td><td>Sleep Timers are used to modify the rate at which an agent sends beacons to a C2 server. (Sleep timer of 10 seconds means that the agent will send a beacon out evety 10 seconds)</td></tr><tr><td>Jitter</td><td>Jitter allows you to add some variability to the sleep timer in order to make the communication/traffic look less sequential. Some C2F provide the ability to modify the packets. (Add random time to avoid suspiciuos sequential traffic)</td></tr></tbody></table>





## C2 Communication&#x20;

### Protocols

C2F frequently use standard network protocols to blend into regular network traffic. Commonly used protocols include:

* **HTTP/S**: These are widely used because they **are less likely to raise suspicion** due to their ubiquity in web traffic. HTTPS adds encryption, providing a layer of security against interception.
* **DNS**: This protocol is sometimes used for C2 communication due to its pervasiveness in networks, **allowing data to be embedded in DNS queries or responses**.
* **Custom Protocols**: Some C2Fs use custom-designed protocols for enhaced flexibility or obfuscation.

### Models

C2F can follow different communication models to facilitate their operations.

Some common models:

#### **Contralized Model**

There is a primary C2 server and all agents call back to that C2 server\


<figure><img src="../../.gitbook/assets/image (169).png" alt="" width="354"><figcaption></figcaption></figure>

#### **P2P** (Peer To Peer) Model

A single compromised host in the botnet maintain communication with the C2 server. This model is used to prevent all PCs connecting to the same website at the same time, and avoid generating suspicious traffic. \


<figure><img src="../../.gitbook/assets/image (104).png" alt="" width="375"><figcaption></figcaption></figure>

Example framework: HavocFramework\
[https://github.com/HavocFramework/Havoc](https://github.com/HavocFramework/Havoc)

#### **Out of Band/Overt Model**&#x20;

Leverages already existing communication protocols and social media. It's very difficult to detect as egress traffic is in the form of communication with services like Twitter or Gmail.

#### **Hybrid Model**&#x20;

Mix of above methods.



## C2 Deployment & Operation

To deploying a C2 infrastructure, it's very important to consider the following factors:

* **Payload delivery** - Method of delivering initial access payload (Email, phishing web delivery etc.).
* **Client-based protections** - What sort of protection mechanisms are installed on target systems (AV, EDR, HIDS, etc).
* **Network-based protections** - Network protection mechanisms present on target network (Egress filtering, IDS/IPS).

### Payload Delivery

The forst step in any operation will involve obtaining initial access to a target system. This may be achieved through the use of various initial access TTPs like:

* Exploiting Public facing applications
* Supply chain compromise
* Phishing
* Valid Accounts

C2F come into the mix into post-exploitation, as a result, you must decide on the means of delivering the C2F payload/stager.

Choose the multi types C2F if the compromised machine are of different type.

### Client-Based Protections

Most C2F stagers/payloads will be easily detected by a modern AV. As a result, you must also factor in evasion of client-based protection mechanisms like AVs, EDRs etc.\
The following techniques are typically used to unsure that the C2F stager/payload evade signature-based AV solutions:

* PE Encoding & Obfuscation
* Shellcode Injection
* PS Encoding & Obfuscation
* PowerSploit - Shellcode injection in memory&#x20;

### Network-Based Protections

Another factor to consider when designing your C2 infrastructure is the network-based protections in place on the target network.

The following best-practices should be observed on the desploying phase:

* Ensure communicazion channel is over a standard port (80, 8080, 443).
* Note: Communication over standard ports will be heavily monitored, as a result, it is recommended to utilize domains over raw IP addresses. (might seem suspicious that a connection points to a IP (of a VPS) and not to a domain). Configure the DNS with a domain Name.&#x20;
* Non-standard ports like TCP 53 can be used to mask communication as legitimate DNS requests.

### Domain Fronting

Domain fronting, is a technique utilized by adversaries in order to conceal the true destination of an HTTP(S) reqiest (from agent in the company network to C2F).\
This is achieved by using a **different domain name in the initial connection request** rather the actual target domain.\
This technique is further embellished through the **use of encryption protocols** like TLS or HTTPS in order **to encrypt/obfuscate** the traffic.

#### Cloudflare

A common service/tool that is leveraged by adversies to facilitate Domain Fronting is **Cloudflare**.\
Adversaries can leverage Cloudflare to make it look like an **agent is communicating with a trusted IP** address (IP Block owned by Cloudflare).

#### Methodology to setting up Domain Fronting with Cloudflare

1. Operator purchases a domain and configures it to utilize Cloudflare nameservers, consequently proxying all requests through Cloudflare (if anyone make a DNS anumeration for the A record, will see the Cloudflare IP).
2. The implant/payload is configured to beacon back to the C2 server domain.
3. Cloudflare receives and proxies the beacon from the agent, analyzes the host header and relays the request/response to the C2 server domain.
4. The C2 server receives the request from Cloudflare and sends a response with commands, which is also proxied through Cloudflare.
5. The response containing commands is then received by the agent via Cloudflare.

<figure><img src="../../.gitbook/assets/image (170).png" alt=""><figcaption><p>C2 Framework with Cloudflare infrastructure</p></figcaption></figure>



## The C2 Matrix - Choosing the correct C2F

The **C2 Matrix** was created to aggregate all the Command-and-Control frameworks publicly available (open-source and commercial) in a single resource to assist teams in testing their own controls through adversary emulations (Red Team or Purple Team Exercises).

The C2 Matrix currently has 35 command and control frameworks documented in a Google Sheet, web site, and questionnaire format.

{% embed url="https://howto.thec2matrix.com/" %}

## &#x20;

