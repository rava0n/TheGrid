# Broken Access Control

<details>

<summary>Access Control </summary>

Access control is a security method that decides who can use a specific resource or system. It makes sure that only people with permission can access things like files, databases, and websites. The main aim is to protect important data and ensure it's only available to those who should see it.

Access control can be implemented in different ways:

1. **Discretionary Access Control (DAC)**: In DAC, the owner or administrator decides who can access a resource and what they can do with it. This method is often used in operating systems and file systems.&#x20;
2. **Mandatory Access Control (MAC)**: In this type of access control, access to resources is determined by a set of predefined rules or policies that are enforced by the system. MAC is commonly used in highly secure environments, such as government and military systems.
3. **Role-Based Access Control (RBAC)**: In this type of access control, users are assigned roles that define their level of access to resources. RBAC is commonly used in enterprise systems, where users have different levels of authority based on their job responsibilities.
4. **Attribute-Based Access Control (ABAC)**: In this type of access control, access to resources is determined by a set of attributes, such as user role, time of day, location, and device. ABAC is commonly used in cloud environments and web applications.

</details>

**Broken access control vulnerabilities** refer to situations where access control mechanisms fail to enforce proper restrictions on user access to resources or data. Here are some common exploits for broken access control and examples:

1. **Horizontal privilege escalation** occurs when an attacker can access resources or data belonging to other users with the same level of access. For example, a user might be able to access another user’s account by changing the user ID in the URL.
2. **Vertical privilege escalation** occurs when an attacker can access resources or data belonging to users with higher access levels. For example, a regular user can access administrative functions by manipulating a hidden form field or URL parameter.
3. **Insufficient access control checks** occur when access control checks are not performed correctly or consistently, allowing an attacker to bypass them. For example, an application might allow users to view sensitive data without verifying their proper permissions.
4. **Insecure direct object references** occur when an attacker can access a resource or data by exploiting a weakness in the application’s access control mechanisms. For example, an application might use predictable or easily guessable identifiers for sensitive data, making it easier for an attacker to access.



## Assessing the Web Application

In this task, our objective is to **gain a comprehensive understanding of the web application’s functionalities**. This will allow us to make the most of the application’s capabilities and achieve our desired outcomes.

### Enumeration WebApp for BAC

* Register page: how a user can registrate and what is the way to create an admin account
* Login page: is it possible do a brute force attack?
* Dashboard: How the page gets if you are admin or not

### Capture HTTP Traffic

Use Burp Suite Tool to capture the HTTP traffic that is being sent to the server in the HTTP History Proxy section.

Try to get these ingormation:

* The target web application **redirects the user to the dashboard with a parameter** that we can possibly test for privilege escalation vulnerabilities.
* The target web application **may does not have any implemented security headers**, which indicates that there are no preventative measures (like a first line of defense) in place to protect the web application against certain types of attacks.
* Determine the **operating system and the web server service in use**. This information can be useful in identifying potential security vulnerabilities that may exist in the target web application.
* Determine the **backend programming language**. This information is important for understanding the technology stack of the application and identifying potential security vulnerabilities or compatibility issues that may arise with other software components.



## Exploiting BAC

### Parameter in Change Profile information

Try to change the parameters and find a flaw in the auth access control.

1. Use the provided feature to update the email address or change password associated with your account.
2. Observe that the response contains your role ID.
3. Send the email submission request to Burp Repeater, add `"roleid":2` into the JSON in the request body, and resend it.
4. Observe that the response shows your `roleid` has changed to 2.



Try to perform a brute force attack

Trivial Password's reset method



### **Broken access control resulting from platform misconfiguration**

Some applications enforce access controls at the platform layer. they do this by restricting access to specific URLs and HTTP methods based on the user's role. For example, an application might configure a rule as follows:

`DENY: POST, /admin/deleteUser, managers`

This rule denies access to the `POST` method on the URL `/admin/deleteUser`, for users in the managers group. Various things can go wrong in this situation, leading to access control bypasses.

Some application frameworks support various non-standard HTTP headers that can be used to override the URL in the original request, such as `X-Original-URL` and `X-Rewrite-URL`. If a website uses rigorous front-end controls to restrict access based on the URL, but the application allows the URL to be overridden via a request header, then it might be possible to bypass the access controls using a request like the following:

`POST / HTTP/1.1 X-Original-URL: /admin/deleteUser ...`



## Mitigations

There are several steps that can be taken to mitigate the risk of broken access control vulnerabilities. The follow exemple is for a PHP application.

<details>

<summary><strong>Implement Role-Based Access Control (RBAC)</strong> </summary>

Role-based access control (RBAC) is a method of regulating access to computer or network resources based on the roles of individual users within an enterprise. By defining roles in an organization and assigning access rights to these roles, you can control what actions a user can perform on a system. The provided code snippet illustrates how you can define roles (such as ‘admin’, ‘editor’, or ‘user’) and the permissions associated with them. The `hasPermission` function checks if a user of a certain role has a specified permission.

```php
// Define roles and permissions
 $roles = [
     'admin' => ['create', 'read', 'update', 'delete'],
     'editor' => ['create', 'read', 'update'],
     'user' => ['read'],
 ];

 // Check user permissions
 function hasPermission($userRole, $requiredPermission) {
     global $roles;
     return in_array($requiredPermission, $roles[$userRole]);
 }

 // Example usage
 if (hasPermission('admin', 'delete')) {
     // Allow delete operation
 } else {
     // Deny delete operation
 }
 
```

</details>

<details>

<summary><strong>Use Parameterized Queries to avoid SQLi</strong></summary>

Parameterized queries are a way to protect PHP applications from SQL Injection attacks, where malicious users could potentially gain unauthorized access to your database. By using placeholders instead of directly including user input into the SQL query, you can significantly reduce the risk of SQL Injection attacks. The provided example demonstrates how a query can be made secure using prepared statements, which separates SQL syntax from data and handles user input safely.

```php
// Example of vulnerable query
 $username = $_POST['username'];
 $password = $_POST['password'];
 $query = "SELECT * FROM users WHERE username='$username' AND password='$password'";

 // Example of secure query using prepared statements
 $username = $_POST['username'];
 $password = $_POST['password'];
 $stmt = $pdo->prepare("SELECT * FROM users WHERE username=? AND password=?");
 $stmt->execute([$username, $password]);
 $user = $stmt->fetch();
```

</details>

<details>

<summary><strong>Proper Session Management</strong></summary>

Proper session management ensures that authenticated users have timely and appropriate access to resources, thereby reducing the risk of unauthorized access to sensitive information. Session management includes using secure cookies, setting session timeouts, and limiting the number of active sessions a user can have. The code snippet shows how to initialize a session, set session variables and check for session validity by looking at the last activity time.

```php
// Start session
 session_start();

 // Set session variables
 $_SESSION['user_id'] = $user_id;
 $_SESSION['last_activity'] = time();

 // Check if session is still valid
 if (isset($_SESSION['last_activity']) && (time() - $_SESSION['last_activity'] > 1800)) {
     // Session has expired
     session_unset();
     session_destroy();
 }
```

</details>

<details>

<summary><strong>Use Secure Coding Practices</strong></summary>

Secure coding practices involve methods to prevent the introduction of security vulnerabilities. Developers should sanitize and validate user input to prevent malicious data from causing harm and avoid using insecure functions or libraries. The given example shows how to sanitize user input using PHP’s `filter_input` function and demonstrates how to securely hash a password using `password_hash` instead of an insecure function like `md5`.

```php
// Validate user input
 $username = filter_input(INPUT_POST, 'username', FILTER_SANITIZE_STRING);
 $password = filter_input(INPUT_POST, 'password', FILTER_SANITIZE_STRING);

 // Avoid insecure functions
 // Example of vulnerable code using md5
 $password = md5($password);
 // Example of secure code using password_hash
 $password = password_hash($password, PASSWORD_DEFAULT);
```

</details>
